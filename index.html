<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>SGPA CALCULATOR</title>
      <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
      <link rel="stylesheet" href="style.css" />
      <link href="https://unpkg.com/boxicons@2.1.2/css/boxicons.min.css" rel="stylesheet" />
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
      <style>
         /* Login Popup Styles */
         .login-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
         }
         
         .login-popup.show {
            display: flex;
         }
         
         .login-container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: relative;
         }
         
         .login-container h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
         }
         
         .form-group {
            position: relative;
            margin-bottom: 25px;
         }
         
         .form-group input {
            width: 100%;
            padding: 10px 0;
            font-size: 16px;
            border: none;
            border-bottom: 1px solid #ddd;
            outline: none;
            background: transparent;
         }
         
         .form-group label {
            position: absolute;
            top: 10px;
            left: 0;
            font-size: 16px;
            color: #999;
            transition: 0.3s;
            pointer-events: none;
         }
         
         .form-group input:focus ~ label,
         .form-group input:valid ~ label {
            top: -20px;
            font-size: 12px;
            color: #5264AE;
         }
         
         .password-toggle {
            position: absolute;
            right: 0;
            top: 10px;
            cursor: pointer;
            color: #999;
         }
         
         .login-container button {
            width: 100%;
            padding: 12px;
            background-color: #5264AE;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            transition: background-color 0.3s;
         }
         
         .login-container button:hover {
            background-color: #3f51b5;
         }
         
         .link-text {
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
            color: #666;
         }
         
         .link {
            color: #5264AE;
            text-decoration: none;
         }
         
         .link:hover {
            text-decoration: underline;
         }
         
         .demo-alert {
            background-color: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
         }
         
         .demo-alert .alert-content {
            font-size: 16px;
            text-align: left;
         }
         
         /* Updated close button styles for all popups */
         .popup__close, .close-login {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #000;
            background: none;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            padding: 0;
            z-index: 10;
         }
         
         .popup__close i, .close-login i {
            color: #000;
         }
         
         /* Make sure popup content has proper positioning */
         .popup__content {
            position: relative;
            padding-top: 20px;
         }
         
         /* Specific style for login popup close button */
         .close-login {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            padding: 0;
            margin: 0;
            width: auto;
            height: auto;
            display: block;
            text-align: right;
         }
         /* Additional styles for the enhanced login popup */
         .text-center {
            text-align: center;
         }
         
         .login-container {
            max-height: 90vh;
            overflow-y: auto;
         }
         
         .resend {
            background-color: transparent;
            color: var(--clr-primary);
            border: 1px solid var(--clr-primary);
            border-radius: 5px;
            padding: 10px 20px;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
         }
         
         /* Login/Register button in nav */
         .auth-button {
            display: flex;
            align-items: center;
            padding: 14px 12px;
            border-radius: 5px;
            text-decoration: none;
            cursor: pointer;
         }
         
         .auth-button .icon {
            margin-right: 14px;
            font-size: 20px;
            color: var(--clr-neutral-300);
         }
         
         .auth-button .link {
            font-size: 16px;
            color: var(--clr-neutral-300);
            font-weight: 400;
         }
         
         .auth-button:hover .icon,
         .auth-button:hover .link {
            color: #fff;
         }
         
         .auth-button:hover {
            background-color: var(--clr-primary);
         }
      </style>
   </head>
   <body>
      <nav>
         <div class="logo">
            <i class="bx bx-menu menu-icon"></i>
            <span class="logo-name">GPA PRO</span>
         </div>
         <div class="sidebar">
            <div class="logo">
               <i class="bx bx-menu menu-icon"></i>
               <span class="logo-name">GPA PRO</span>
            </div>
            <div class="sidebar-content">
               <ul class="lists">
                  <li class="list">
                     <a href="dashboard.html" class="nav-link">
                     <i class="bx bx-home-alt icon"></i>
                     <span class="link">Dashboard</span>
                     </a>
                  </li>
                  <li class="list">
                     <a href="#" class="nav-link active-link">
                     <i class="bx bx-calculator icon"></i>
                     <span class="link">SGPA Calculator</span>
                     </a>
                  </li>
                  <li class="list">
                     <a href="cgpa_calculator.html" class="nav-link">
                     <i class="bx bx-calculator icon"></i>
                     <span class="link">CGPA Calculator</span>
                     </a>
                  </li>
                  <li class="list">
                     <a href="profile.html" class="nav-link">
                     <i class="bx bx-user icon"></i>
                     <span class="link">Profile</span>
                     </a>
                  </li>
               </ul>
               <div class="bottom-content" id="authButtons">
                  <!-- This will be populated dynamically based on login status -->
               </div>
            </div>
         </div>
      </nav>
      <section class="overlay"></section>
      <div class="toast-container"></div>
      <div class="content">
         <h2>SGPA Calculator</h2>
         <div class="btn-container">
            <button class="change-grade-system-btn" onclick="openPopUpBox2()">Change Grading System</button>
         </div>
         <form id="sgpaForm">
            <div id="courseInputs">
               <div class="courseRow">
                  <input type="text" name="course_code[]" placeholder="Course Code" required>
                  <input type="text" name="course_name[]" placeholder="Course Name" required>
                  <input type="number" name="credit[]" placeholder="Credit" required>
                  <select id="sgpaGradeSelect" name="grade[]" required>
                     <option value="">Select Grade</option>
                     <option value="10">S</option>
                     <option value="9">A</option>
                     <option value="8">B</option>
                     <option value="7">C</option>
                     <option value="6">D</option>
                     <option value="5">E</option>
                     <option value="0">F</option>
                  </select>
                  <span class="icon-wrapper">
                     <i class="fas fa-ellipsis-v" onclick="toggleOptions(this)"></i>
                     <div class="options-container">
                        <button onclick="duplicateAndHide(this)">Duplicate</button>
                        <button onclick="deleteCourse(this)">Delete</button>
                     </div>
                  </span>
               </div>
            </div>
            <div class="buttons-container">
               <button class="add-b" type="button" onclick="addCourse()">Add Course</button>
               <button type="button" onclick="calculateSGPA()" id="open-sgpa">Calculate SGPA</button>
            </div>
         </form>
         <div class="popup__box" id="popup-box">
            <div class="popup__content">
               <div class="popup__close close-popup" title="Close">
                  <i class='bx bx-x'></i>
               </div>
               <h1 class="popup__title">SGPA : 10</h1>
               <p class="popup__description">Percent Average : 95 %</p>
               <button class="popup__button" id="addToProfileBtn">Add to profile</button>
               <button class="popup__button-link close-popup">Close</button>
            </div>
         </div>
         <div class="popup__box" id="popup-box2">
            <div class="popup__content">
               <div class="popup__close close-popup" title="Close">
                  <i class='bx bx-x'></i>
               </div>
               <h1 class="popup__title">Change Grade System</h1>
               <p class="popup__description">Customize your grading system</p>
               <div class="gradeRow">
                  <input type="text" name="grade[]" placeholder="Grade" value="S" required>
                  <input type="text" name="point[]" placeholder="Grade Point" value="10" required>
                  <i class='bx bx-trash delete-grade' title="Delete"></i>
               </div>
               <div class="gradeRow">
                  <input type="text" name="grade[]" placeholder="Grade" value="A" required>
                  <input type="text" name="point[]" placeholder="Grade Point" value="9" required>
                  <i class='bx bx-trash delete-grade' title="Delete"></i>
               </div>
               <div class="gradeRow">
                  <input type="text" name="grade[]" placeholder="Grade" value="B" required>
                  <input type="text" name="point[]" placeholder="Grade Point" value="8" required>
                  <i class='bx bx-trash delete-grade' title="Delete"></i>
               </div>
               <div class="gradeRow">
                  <input type="text" name="grade[]" placeholder="Grade" value="C" required>
                  <input type="text" name="point[]" placeholder="Grade Point" value="7" required>
                  <i class='bx bx-trash delete-grade' title="Delete"></i>
               </div>
               <div class="gradeRow">
                  <input type="text" name="grade[]" placeholder="Grade" value="D" required>
                  <input type="text" name="point[]" placeholder="Grade Point" value="6" required>
                  <i class='bx bx-trash delete-grade' title="Delete"></i>
               </div>
               <div class="gradeRow">
                  <input type="text" name="grade[]" placeholder="Grade" value="E" required>
                  <input type="text" name="point[]" placeholder="Grade Point" value="5" required>
                  <i class='bx bx-trash delete-grade' title="Delete"></i>
               </div>
               <div class="gradeRow">
                  <input type="text" name="grade[]" placeholder="Grade" value="F" required>
                  <input type="text" name="point[]" placeholder="Grade Point" value="0" required>
                  <i class='bx bx-trash delete-grade' title="Delete"></i>
               </div>
               <div class="buttons-container">
                  <button class="popup__button add-g">Add Grade</button>
                  <button class="popup__button saveBtn">Save</button>
               </div>
               <button class="popup__button-link close-popup">Close</button>
            </div>
         </div>
         <div class="popup__box" id="popup-box3">
            <div class="popup__content">
               <div class="popup__close close-popup" title="Close">
                  <i class='bx bx-x'></i>
               </div>
               <p class="popup__description">Enter your course and institution details</p>
               <div class="course-details">
                  <select id="institution" required>
                     <option value="" selected>Select Institution</option>
                     <option value="Others">Others</option>
                  </select>
                  <input type="text" id="institutionInput" name="institution[]" placeholder="Your Institution Name" style="display: none;" required>
                  <select id="program" required>
                     <option value="" selected>Select Program</option>
                     <option value="Others">Others</option>
                  </select>
                  <input type="text" id="programInput" name="program[]" placeholder="Your Program Name" style="display: none;" required>
                  <input type="text" name="semester[]" placeholder="Semester" required>
               </div>
               <button class="popup__button" id="finalAddToProfileBtn">Add to profile</button>
               <button class="popup__button-link close-popup">Close</button>
            </div>
         </div>
         
         <!-- Login Popup -->
         <div class="login-popup" id="loginPopup">
            <div class="login-container">
               <div class="close-login" id="closeLogin" title="Close">
                  <i class="fas fa-times"></i>
               </div>
               
               <!-- Login Form -->
               <div id="loginFormContainer">
                  <h2>Login to your account</h2>
                  
                  <!-- Demo Alert -->
                  <div class="demo-alert" id="demoAlert">
                     <div class="alert-content">
                        <strong>Demo Login Credentials:</strong> <br>
                        <strong>Username:</strong> demo <br>
                        <strong>Password:</strong> demogpapro
                     </div>
                  </div>
                  
                  <form class="form" id="loginForm">
                     <div class="form-group">
                        <input type="text" name="username" id="username" required>
                        <label for="username">Username</label>
                     </div>
                     <div class="form-group">
                        <input type="password" name="password" id="password" required>
                        <label for="password">Password</label>
                        <i class="fas fa-eye password-toggle" id="togglePassword"></i>
                     </div>
                     <button type="submit">Login</button>
                  </form>
                  <p class="link-text">Don't have an account? <a href="#" class="link" id="showRegisterForm">Register here</a>.</p>
                  <p class="link-text">Forgot your password? <a href="#" class="link" id="showResetForm">Reset here</a>.</p>
               </div>
               
               <!-- Register Form -->
               <div id="registerFormContainer" style="display: none;">
                  <h2>Create your account</h2>
                  <form class="form" id="registerForm">
                     <div class="form-group">
                        <input type="text" name="fullname" id="fullname" required>
                        <label for="fullname">Full Name</label>
                     </div>
                     <div class="form-group">
                        <input type="email" name="email" id="registerEmail" required>
                        <label for="registerEmail">Email</label>
                     </div>
                     <div class="form-group">
                        <input type="text" name="username" id="registerUsername" required>
                        <label for="registerUsername">Username</label>
                     </div>
                     <div class="form-group">
                        <input type="password" name="password" id="registerPassword" required>
                        <label for="registerPassword">Password</label>
                        <i class="fas fa-eye password-toggle" id="toggleRegisterPassword"></i>
                     </div>
                     <button type="submit">Register</button>
                  </form>
                  <p class="link-text">Already have an account? <a href="#" class="link" id="showLoginForm">Login here</a>.</p>
               </div>
               
               <!-- Reset Password Form -->
               <div id="resetFormContainer" style="display: none;">
                  <h2>Reset Your Password</h2>
                  <form class="form" id="resetPasswordRequestForm">
                     <p class="text-center">Enter your email address and we will send you instructions to reset your password.</p>
                     <div class="form-group">
                        <input type="email" name="email" id="resetEmail" required>
                        <label for="resetEmail">Enter your email</label>
                     </div>
                     <button type="submit">Submit</button>
                  </form>
                  <p class="link-text">Remember your password? <a href="#" class="link" id="backToLoginForm">Back to login</a>.</p>
               </div>
               
               <!-- Reset Password Email Sent Confirmation -->
               <div id="checkEmailContainer" style="display: none;">
                  <h2>Check your email</h2>
                  <p class="text-center">Please check your email for instructions to reset your password.</p>
                  <form class="form" id="resendLinkForm">
                     <button class="resend" type="submit">Resend email</button>
                  </form>
                  <p class="link-text"><a href="#" class="link" id="backToLoginFromReset">Back to login</a>.</p>
               </div>
            </div>
         </div>
      </div>
      
      <script>
         // Add a flag to track if the login popup was opened from "Add to profile"
         // Add this variable near the top of the script section
         let loginFromAddToProfile = false;
         
         // Make the calculator visible to all users
         document.querySelector('body').style.display = "block";
         
         // Check login status and update UI accordingly
         function checkLoginStatus() {
            $.ajax({
               type: "GET",
               url: "check_login.php",
               success: function(response) {
                  const authButtonsContainer = document.getElementById('authButtons');
                  
                  if (response === 'logged_in') {
                     // User is logged in, show logout button
                     authButtonsContainer.innerHTML = `
                     <li class="list">
                     <a href="logout.php" class="nav-link">
                     <i class="bx bx-log-out icon"></i>
                     <span class="link">Logout</span>
                     </a>
                     </li>
                     `;
                  } else {
                     // User is not logged in, show login/signup button
                     authButtonsContainer.innerHTML = `
                     <li class="list">
                     <a href="#" class="nav-link auth-button" id="navLoginButton">
                     <i class="bx bx-log-in icon"></i>
                     <span class="link">Login / Sign Up</span>
                     </a>
                     </li>
                     `;
                     
                     // Add event listener to the login button
                     document.getElementById('navLoginButton').addEventListener('click', function(e) {
                        e.preventDefault();
                        document.getElementById('loginPopup').classList.add('show');
                     });
                  }
               }
            });
         }
         
         // Call the function when the page loads
         document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
         });
         
         // Toggle password visibility for login form
         document.getElementById('togglePassword').addEventListener('click', function() {
            const passwordInput = document.getElementById('password');
            if (passwordInput.type === 'password') {
               passwordInput.type = 'text';
               this.classList.remove('fa-eye');
               this.classList.add('fa-eye-slash');
            } else {
               passwordInput.type = 'password';
               this.classList.remove('fa-eye-slash');
               this.classList.add('fa-eye');
            }
         });
         
         // Toggle password visibility for register form
         document.getElementById('toggleRegisterPassword').addEventListener('click', function() {
            const passwordInput = document.getElementById('registerPassword');
            if (passwordInput.type === 'password') {
               passwordInput.type = 'text';
               this.classList.remove('fa-eye');
               this.classList.add('fa-eye-slash');
            } else {
               passwordInput.type = 'password';
               this.classList.remove('fa-eye-slash');
               this.classList.add('fa-eye');
            }
         });
         
         // Form switching functions
         document.getElementById('showRegisterForm').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('loginFormContainer').style.display = 'none';
            document.getElementById('registerFormContainer').style.display = 'block';
            document.getElementById('resetFormContainer').style.display = 'none';
            document.getElementById('checkEmailContainer').style.display = 'none';
         });
         
         document.getElementById('showLoginForm').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('loginFormContainer').style.display = 'block';
            document.getElementById('registerFormContainer').style.display = 'none';
            document.getElementById('resetFormContainer').style.display = 'none';
            document.getElementById('checkEmailContainer').style.display = 'none';
         });
         
         document.getElementById('showResetForm').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('loginFormContainer').style.display = 'none';
            document.getElementById('registerFormContainer').style.display = 'none';
            document.getElementById('resetFormContainer').style.display = 'block';
            document.getElementById('checkEmailContainer').style.display = 'none';
         });
         
         document.getElementById('backToLoginForm').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('loginFormContainer').style.display = 'block';
            document.getElementById('registerFormContainer').style.display = 'none';
            document.getElementById('resetFormContainer').style.display = 'none';
            document.getElementById('checkEmailContainer').style.display = 'none';
         });
         
         document.getElementById('backToLoginFromReset').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('loginFormContainer').style.display = 'block';
            document.getElementById('registerFormContainer').style.display = 'none';
            document.getElementById('resetFormContainer').style.display = 'none';
            document.getElementById('checkEmailContainer').style.display = 'none';
         });
         
         // Close login popup
         document.getElementById('closeLogin').addEventListener('click', function() {
            document.getElementById('loginPopup').classList.remove('show');
         });
         
         // Modify the addToProfileBtn click handler to set the flag
         document.getElementById('addToProfileBtn').addEventListener('click', function() {
            // Check if user is logged in
            $.ajax({
               type: "GET",
               url: "check_login.php",
               success: function(response) {
                  if (response === 'logged_in') {
                     // User is logged in, show the course details popup
                     document.getElementById('popup-box3').classList.add('show-popup');
                  } else {
                     // User is not logged in, show login popup
                     loginFromAddToProfile = true; // Set the flag
                     document.getElementById('loginPopup').classList.add('show');
                  }
               }
            });
         });
         
         // Modify the login form submission handler to update the navigation bar
         document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            $.ajax({
               type: "POST",
               url: "login.php",
               data: $(this).serialize(),
               success: function(response) {
                  if (response === 'success') {
                     createToast('success', 'Login successful!');
                     document.getElementById('loginPopup').classList.remove('show');
                     
                     // Update the navigation bar to show logout button
                     checkLoginStatus();
                     
                     // Check if login was initiated from "Add to profile"
                     if (loginFromAddToProfile) {
                        // Reset the flag
                        loginFromAddToProfile = false;
                        // Show the course details popup
                        document.getElementById('popup-box3').classList.add('show-popup');
                     }
                  } else {
                     createToast('error', response);
                  }
               }
            });
         });
         
         // Modify the register form submission handler to update the navigation bar
         document.getElementById('registerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = $(this).serialize();
            
            $.ajax({
               type: "POST",
               url: "register.php",
               data: formData,
               success: function(response) {
                  const data = JSON.parse(response);
                  if (data.status === 'success') {
                     createToast('success', data.message);
                     
                     // Extract username and password for auto-login
                     const username = document.getElementById('registerUsername').value;
                     const password = document.getElementById('registerPassword').value;
                     
                     // Auto-login after successful registration
                     $.ajax({
                        type: "POST",
                        url: "login.php",
                        data: { username: username, password: password },
                        success: function(loginResponse) {
                           if (loginResponse === 'success') {
                              document.getElementById('loginPopup').classList.remove('show');
                              
                              // Update the navigation bar to show logout button
                              checkLoginStatus();
                              
                              // Check if registration was initiated from "Add to profile"
                              if (loginFromAddToProfile) {
                                 // Reset the flag
                                 loginFromAddToProfile = false;
                                 // Show the course details popup
                                 document.getElementById('popup-box3').classList.add('show-popup');
                              }
                           } else {
                              createToast('error', 'Auto-login failed. Please login manually.');
                              // Switch to login form
                              document.getElementById('showLoginForm').click();
                           }
                        }
                     });
                  } else {
                     createToast('error', data.message);
                  }
               }
            });
         });
         
         // Update the reset password request form submission handler to match reset_password_request.html
         document.getElementById('resetPasswordRequestForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('resetEmail').value;
            
            $.ajax({
               type: "POST",
               url: "reset_password_request.php",
               data: { email: email },
               success: function(response) {
                  if (response === 'not_registered') {
                     createToast('error', 'Email is not registered.');
                  } else if (response === 'success') {
                     // Hide reset form and show check email container
                     document.getElementById('resetFormContainer').style.display = 'none';
                     document.getElementById('checkEmailContainer').style.display = 'block';
                     createToast('success', 'Password reset link sent to your email!');
                     
                     // Store email for resend functionality
                     document.getElementById('resendLinkForm').addEventListener('submit', function(e) {
                        e.preventDefault();
                        $.ajax({
                           type: "POST",
                           url: "reset_password_request.php",
                           data: { email: email },
                           success: function(response) {
                              if (response === 'success') {
                                 createToast('success', 'Password reset link sent again to your email!');
                              } else {
                                 createToast('error', response);
                              }
                           }
                        });
                     });
                  } else {
                     createToast('error', response);
                  }
               }
            });
         });
         
         // Check login status when Add to profile is clicked
         
         
         // Handle final add to profile
         document.getElementById('finalAddToProfileBtn').addEventListener('click', function() {
            const sgpa = document.querySelector('#popup-box .popup__title').textContent.replace('SGPA : ', '');
            
            const institutionSelect = document.querySelector('#institution');
            const institution = institutionSelect.value === 'Others' ? document.querySelector('#institutionInput').value : institutionSelect.value;
            
            const programSelect = document.querySelector('#program');
            const program = programSelect.value === 'Others' ? document.querySelector('#programInput').value : programSelect.value;
            
            const semester = document.querySelector('input[name="semester[]"]').value;
            
            const sgpaData = {
               sgpa: sgpa,
               institution: institution,
               program: program,
               semester: semester
            };
            
            $.ajax({
               type: "POST",
               url: "save_sgpa.php",
               data: JSON.stringify(sgpaData),
               contentType: "application/json",
               success: function(response) {
                  if (response === 'success') {
                     cancelAll();
                     createToast('success', 'SGPA data saved successfully!');
                  } else {
                     createToast('error', response);
                  }
               }
            });
         });
         
         function toggleOptions(icon) {
            const optionsContainer = icon.parentElement.querySelector('.options-container');
            if (optionsContainer.style.display === "none") {
               optionsContainer.style.display = "block"; 
            } else {
               optionsContainer.style.display = "none"; 
            }
         }
         
         function duplicateAndHide(button) {
            const courseRow = button.closest('.courseRow');
            const clonedCourseRow = courseRow.cloneNode(true); 
            courseRow.parentElement.insertBefore(clonedCourseRow, courseRow.nextSibling); 
            const allOptionsContainers = document.querySelectorAll('.options-container'); 
            allOptionsContainers.forEach(container => {
               container.style.display = "none"; 
            });
         }
         
         function deleteCourse(button) {
            const courseRow = button.closest('.courseRow');
            courseRow.remove(); 
         }
         
         function addCourse() {
            const courseInputs = document.getElementById('courseInputs');
            const newCourseRow = document.createElement('div');
            newCourseRow.classList.add('courseRow');
            
            const userGrades = getUserGrades();
            
            const selectOptions = generateSelectOptions(userGrades);
            
            newCourseRow.innerHTML = `
            <input type="text" name="course_code[]" placeholder="Course Code" required>
            <input type="text" name="course_name[]" placeholder="Course Name" required>
            <input type="number" name="credit[]" placeholder="Credit" required>
            <select id="sgpaGradeSelect" name="grade[]" required>
            ${selectOptions}
            </select>
            <span class="icon-wrapper">
            <i class="fas fa-ellipsis-v" onclick="toggleOptions(this)"></i>
            <div class="options-container">
            <button onclick="duplicateAndHide(this)">Duplicate</button>
            <button onclick="deleteCourse(this)">Delete</button>
            </div>
            </span>
            `;
            courseInputs.appendChild(newCourseRow);
         }
         
         function getUserGrades() {
            const userGradeInputs = document.querySelectorAll('#popup-box2 input[name="grade[]"]');
            const userPointInputs = document.querySelectorAll('#popup-box2 input[name="point[]"]');
            const userGrades = [];
            
            userGradeInputs.forEach((gradeInput, index) => {
               const grade = gradeInput.value;
               const point = userPointInputs[index].value;
               if (grade && point) {
                  userGrades.push({ grade, point });
               }
            });
            
            return userGrades;
         }
         
         function generateSelectOptions(userGrades) {
            let options = '<option value="">Select Grade</option>';
            userGrades.forEach(grade => {
               options += `<option value="${grade.point}">${grade.grade}</option>`;
            });
            return options;
         }
         
         function closeSgpaResultBox() {
            const clickedContainer = this.closest('.popup__box');
            clickedContainer.classList.remove('show-popup');
         }
         
         const closeButtons = document.querySelectorAll('.close-popup');
         
         closeButtons.forEach(button => {
            button.addEventListener('click', closeSgpaResultBox);
         });
         
         function cancelAll() {
            const cancelButtons = document.querySelectorAll('.close-popup');
            cancelButtons.forEach(button => {
               button.click(); 
            });
            document.getElementById('loginPopup').classList.remove('show');
         }
         
         function calculateSGPA() {
            const courseRows = document.querySelectorAll('.courseRow');
            let totalCreditPoints = 0;
            let totalCredits = 0;
            
            courseRows.forEach(courseRow => {
               const grade = courseRow.querySelector('select[name="grade[]"]').value;
               const credit = parseFloat(courseRow.querySelector('input[name="credit[]"]').value);
               
               if (grade && credit) {
                  totalCreditPoints += parseFloat(grade) * credit;
                  totalCredits += credit;
               }
            });
            
            if (totalCredits === 0) {
               alert("Please fill in all course information.");
               return;
            }
            
            const sgpa = totalCreditPoints / totalCredits;
            const percentage = sgpa * 9.5;
            
            const sgpaTitleElement = document.querySelector('.popup__title');
            const percentageDescriptionElement = document.querySelector('.popup__description');
            
            sgpaTitleElement.textContent = "SGPA : " + sgpa.toFixed(2);
            percentageDescriptionElement.textContent = "Percent Average : " + percentage.toFixed(2) + "%";
            
            const sgpaContainer = document.getElementById('popup-box');
            sgpaContainer.classList.add('show-popup');
         }
         
         const navBar = document.querySelector("nav"),
            menuBtns = document.querySelectorAll(".menu-icon"),
            overlay = document.querySelector(".overlay"),
            navLinks = document.querySelectorAll(".nav-link");
         
         menuBtns.forEach((menuBtn) => {
            menuBtn.addEventListener("click", () => {
               navBar.classList.toggle("open");
            });
         });
         
         overlay.addEventListener("click", () => {
            navBar.classList.remove("open");
         });
         
         navLinks.forEach((link) => {
            link.addEventListener("click", () => {
               navBar.classList.remove("open");
            });
         });
         
         // Modify the createToast function to not redirect on success
         function createToast(type, message) {
            var toastContainer = document.querySelector('.toast-container');
            var toast = document.createElement("div");
            toast.classList.add("toast", type);
            toast.innerHTML = '<span>' + message + '</span>' +
               '<i class="fas fa-times-circle close-icon"></i>';
            toastContainer.appendChild(toast);
            
            toast.querySelector('.close-icon').addEventListener('click', function() {
               toast.remove();
            });
            
            setTimeout(function() {
               toast.remove();
            }, 5000);
         }
         
         function openPopUpBox2() {
            document.getElementById('popup-box2').classList.add('show-popup');
         }
         
         function closePopUpBox2() {
            const popupBox = document.getElementById('popup-box2');
            popupBox.classList.remove('show-popup');
         }
         
         function addGradeRow() {
            const newGradeRow = document.createElement('div');
            newGradeRow.classList.add('gradeRow');
            
            const gradeInput = document.createElement('input');
            gradeInput.type = 'text';
            gradeInput.name = 'grade[]';
            gradeInput.placeholder = 'Grade';
            gradeInput.required = true;
            
            const pointInput = document.createElement('input');
            pointInput.type = 'text';
            pointInput.name = 'point[]';
            pointInput.placeholder = 'Grade Point';
            pointInput.required = true;
            
            const deleteButton = document.createElement('i');
            deleteButton.classList.add('bx', 'bx-trash', 'delete-grade');
            deleteButton.title = 'Delete';
            deleteButton.addEventListener('click', function() {
               const gradeRow = deleteButton.closest('.gradeRow');
               gradeRow.remove();
            });
            
            newGradeRow.appendChild(gradeInput);
            newGradeRow.appendChild(pointInput);
            newGradeRow.appendChild(deleteButton);
            
            const buttonsContainer = document.querySelector('.popup__content .buttons-container');
            buttonsContainer.parentNode.insertBefore(newGradeRow, buttonsContainer);
         }
         
         const addGradeButton = document.querySelector('.add-g');
         addGradeButton.addEventListener('click', addGradeRow);
         
         document.querySelectorAll('.delete-grade').forEach(button => {
            button.addEventListener('click', function() {
               const gradeRow = button.closest('.gradeRow');
               gradeRow.remove();
            });
         });
         
         const saveButton = document.querySelector('#popup-box2 .saveBtn');
         saveButton.addEventListener('click', function() {
            saveGrades();
            closePopUpBox2();
         });
         
         function saveGrades() {
            const newGradeInputs = document.querySelectorAll('#popup-box2 input[name="grade[]"]');
            const newPointInputs = document.querySelectorAll('#popup-box2 input[name="point[]"]');
            
            const sgpaGradeSelect = document.getElementById('sgpaGradeSelect');
            const existingOptions = sgpaGradeSelect.querySelectorAll('option:not(:first-child)');
            existingOptions.forEach(option => option.remove());
            
            newGradeInputs.forEach((gradeInput, index) => {
               const grade = gradeInput.value;
               const point = newPointInputs[index].value;
               
               if (grade && point) {
                  const newOption = document.createElement('option');
                  newOption.value = point;
                  newOption.textContent = grade;
                  sgpaGradeSelect.appendChild(newOption);
               }
            });
            
            updateExistingRows();
         }
         
         function updateExistingRows() {
            const courseRows = document.querySelectorAll('.courseRow');
            
            const sgpaGradeSelect = document.getElementById('sgpaGradeSelect');
            const gradeOptions = sgpaGradeSelect.querySelectorAll('option');
            
            courseRows.forEach(courseRow => {
               const gradeSelect = courseRow.querySelector('select[name="grade[]"]');
               
               const existingOptions = gradeSelect.querySelectorAll('option');
               existingOptions.forEach(option => option.remove());
               
               gradeOptions.forEach(option => {
                  const newOption = document.createElement('option');
                  newOption.value = option.value;
                  newOption.textContent = option.textContent;
                  gradeSelect.appendChild(newOption);
               });
            });
         }
         
         // Fetch institution and program options
         function fetchOptions() {
            fetch('get_options.php')
               .then(response => response.json())
               .then(data => {
                  populateSelect('institution', data.institutions);
                  populateSelect('program', data.programs);
               })
               .catch(error => console.error('Error fetching options:', error));
         }
         
         function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            if (!select) {
               console.error(`${selectId} select element not found`);
               return;
            }
            select.innerHTML = '';
            
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = `Select ${selectId.charAt(0).toUpperCase() + selectId.slice(1)}`;
            select.appendChild(defaultOption);
            
            options.forEach(option => {
               const optionElement = document.createElement('option');
               optionElement.value = option;
               optionElement.textContent = option;
               select.appendChild(optionElement);
            });
            
            const othersOption = document.createElement('option');
            othersOption.value = 'Others';
            othersOption.textContent = 'Others';
            select.appendChild(othersOption);
         }
         
         document.getElementById('institution').addEventListener('change', function() {
            const institutionInput = document.getElementById('institutionInput');
            if (!institutionInput) {
               console.error('Institution input element not found');
               return;
            }
            if (this.value === 'Others') {
               institutionInput.style.display = '';
            } else {
               institutionInput.style.display = 'none';
            }
         });
         
         document.getElementById('program').addEventListener('change', function() {
            const programInput = document.getElementById('programInput');
            if (!programInput) {
               console.error('Program input element not found');
               return;
            }
            if (this.value === 'Others') {
               programInput.style.display = '';
            } else {
               programInput.style.display = 'none';
            }
         });
         
         // Initialize the page
         document.addEventListener("DOMContentLoaded", function() {
            fetchOptions();
         });
      </script>
   </body>
</html>

